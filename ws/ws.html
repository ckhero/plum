
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>FastBull BestBull</title>
    <link rel="stylesheet" href="./layui/css/layui.css">
</head>

<body>
<!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
<!--[if lt IE 9]>
<script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
<script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<div class="layui-container">
    <br>

    <h1>FastBull BestBull</h1>
    <br>
    <div class="layui-row layui-col-space1">
        <div class="layui-col-xs2">
            房间
        </div>
        <div class="layui-col-xs5" id="room">

        </div>
        <div class="layui-col-xs2 " >
            状态
        </div>
        <div class="layui-col-xs3" id="result">
            初始化
        </div>
    </div>
    <div class="layui-row layui-col-space1">
        <div class="layui-col-xs12">
            得分
        </div>
    </div>
    <div class="layui-row layui-col-space1" id ="score">

    </div>
</div>


<div id="question" style="background-color: white; padding: 10px; margin: 20px; border-radius: 5px"></div>
<div id="options" style="background-color: white; padding: 10px; margin: 20px; border-radius: 5px"></div>
</body>

<script src="./layui/layui.js"></script>
<script src="./layui/jquery.js"></script>
<script type="text/javascript">
    var sock = null;
    var canSend = true
    // var wsuri = "ws://172.16.42.31:53743/eday/brain-storm/battle/" + GetQueryValue1("uuid");
    var wsuri = "ws://localhost:9090/eday/brain-storm/battle/" + GetQueryValue1("uuid");
    createWebSocket()
    sock.onopen = function() {
        result.innerHTML = "匹配中...";
    }
    window.onbeforeunload = function(event) {
        console.log("关闭WebSocket连接！");
        sock.close();
    }
    function createWebSocket() {
        try {
            sock = new WebSocket(wsuri);
            initEventHandle();
        } catch (e) {
            reconnect(url);
        }
    }
    function initEventHandle() {

        sock.onclose = function () {
            console.log("close")
            // reconnect();
        };
        sock.onerror = function () {
            console.log("error")

            // reconnect();
        };
        /**
         * 接收消息
         * @param e
         */
        sock.onmessage = function(e) {
            var result = document.getElementById('result');
            var room = document.getElementById('room');
            var question = document.getElementById('question');
            var options = document.getElementById('options');
            var score = document.getElementById('score');
            data = JSON.parse(e.data)
            console.log(data.data)
            if (data.code == 0) {
                result.innerHTML = conertToText(data.data.action);
                console.log(data.data.nextAction)
                if (data.data.nextAction == "reconn") {
                    senddefault()
                }
                if (data.data.action == "next") {

                    canSend = true

                    room.innerHTML = data.data.room.roomUuid;
                    options.innerHTML = ""
                    question.innerHTML = ""
                    question.innerHTML = "题目：" + data.data.question.questionDesc
                    questionData = data.data.question
                    list = questionData.questionOptionList
                    console.log(list)
                    str = ""
                    if (list != null) {
                        for (let i = 0; i < list.length; i++) {
                            str += "<div style='padding:10px;margin: 10px' onclick='sendres(\"" + list[i].questionOptionName + "\"," + questionData.questionId +")'>"
                            str += list[i].questionOptionName + ":" + list[i].questionOptionDesc
                            str += "</div>"
                        }
                    }

                    console.log(str)
                    options.innerHTML = str
                    score.innerHTML = "";
                    // intervalID =setInterval("checkSend()",10000);
                } else if (data.data.action == "end") {
                    canSend = true

                    score.innerHTML = "";
                    options.innerHTML = ""
                    question.innerHTML = ""
                    aaaa = data.data.score
                    console.log(document.getElementById('score').innerText)
                    score.innerHTML = document.getElementById('score').innerText + "<span class='span-text-head' style='width: 50%;display: inline'>用户:</span><span class='span-text'>"+ aaaa.userUuid +"</span><span class='span-text-head'>得分:</span><span class='span-text-head'>"+ aaaa.score+ "<br/>"+";</span>" +
                        "<span class='span-text-head'>排名:</span><span class='span-text-head-small'>"+ aaaa.rank+ "</span><br/>"
                } else if (data.data.action == "score") {
                    aaaa = data.data.score
                    console.log(document.getElementById('score').innerText)
                    // score.innerHTML = document.getElementById('score').innerText + "<br/><span class='span-text-head' style='width: 50%'>用户:</span><span class='span-text'>"+ aaaa.userUuid +"</span>" +
                    //     "<span class='span-text-head'>得分:</span><span class='span-text-head-small'>"+ aaaa.score+ "<br/>"+";</span><br/>"
                    str  =  "<div class=\"layui-col-xs2\">\n用户</div><div class=\"layui-col-xs4\">\n:"+ aaaa.userUuid +"</div><div class=\"layui-col-xs2\">\n得分:</div><div class=\"layui-col-xs4\">\n"+ aaaa.score + "</div>";
                    $("#score").append(str)
                } else {
                    canSend = true
                    room.innerHTML = data.data.room.roomUuid;
                }

            } else {
                result.innerHTML = "出错了";
            }
        }


    }
    function checkSend() {
        if (canSend) {
            canSend = false
            senddefault()
        }
    }
    function send() {
        if (!canSend) {
            console.log("repea")
        }
        canSend = false
        var msg = document.getElementById('content').value;
        sock.send(msg);
    }
    function sendres(option, id) {
        if (!canSend) {
            console.log("repea")
            return
        }
        canSend = false
        var msg = {action: "next", "question":{questionId:id,questionOption:option, costTime:(Math.ceil(Math.random() * 9) + 1)}}
        console.log(JSON.stringify(msg))
        sock.send(JSON.stringify(msg));
    }
    function senddefault() {

        console.log("recoon")
        var msg = {action: "reconn"}
        console.log(JSON.stringify(msg))
        sock.send(JSON.stringify(msg));
    }
    function GetQueryValue1(queryName) {
        var reg = new RegExp("(^|&)" + queryName + "=([^&]*)(&|$)", "i");
        var r = window.location.search.substr(1).match(reg);
        if ( r != null ){
            return decodeURI(r[2]);
        }else{
            return null;
        }
    }

    lockReconnect = false
    function reconnect() {
        if(lockReconnect) return;
        lockReconnect = true;
        //没连接上会一直重连，设置延迟避免请求过多
        setTimeout(function () {
            createWebSocket()
            lockReconnect = false;
        }, 1000);
    }
    function conertToText(action) {
        if (action == "match") {
            return "匹配中.."
        }

        if (action == "start") {
            return "匹配成功"
        }

        if (action == "next") {
            return "答题中"
        }
        if (action == "end") {
            return "答题结束"
        }
        if (action == "score") {
            return "答题中"
        }
    }


</script>
</body>
</html>
